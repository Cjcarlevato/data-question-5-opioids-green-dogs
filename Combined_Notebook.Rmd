---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=11, fig.height = 6)

library(tidyverse)
library(plotly)
library(tidyr)
library(ggmap)
library(dplyr)
require(scales)
library(ggpubr)
library(directlabels)
library(qcc)
library(magrittr)
library(caret)
```


```{r, echo=FALSE, include = FALSE}
state_abbrev <- read_csv('data/overdoses.csv') %>% select(State, Abbrev)
overdoses <- read_csv('data/State/overdose_full.csv') %>% inner_join(state_abbrev)
l <- list(color = toRGB("white"), width = 2)
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = FALSE,
  lakecolor = toRGB('white')
)


p_2016 <- plot_geo(overdoses %>% filter(Year == 2016), locationmode = 'USA-states') %>%
  add_trace(
    z = ~Opioid_Death_Rate, locations = ~Abbrev,
    colors = 'Reds'
  ) %>%
  colorbar(title = "    Deaths \nPer 100,000 Residents") %>%
  layout(
    title = 'Opioid Deaths per 100,000 Residents, 2016',
    titlefont = list(size = 24),
        margin = list(t = 50, b = 50), 
    geo = g,
    annotations = 
 list(x = 1, y = -0.1, text = "Source: Henry J Kaiser Family Foundation", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=0,
      font=list(size=12)))

p_2006 <- plot_geo(overdoses %>% filter(Year == 2006), locationmode = 'USA-states') %>%
  add_trace(
    z = ~Opioid_Death_Rate, locations = ~Abbrev, zmin = 0, zmax = 43,
    colors = 'Reds'
  ) %>%
  colorbar(title = "    Deaths \nPer 100,000 Residents") %>%
  layout(
    title = 'Opioid Deaths per 100,000 Residents, 2006',
    titlefont = list(size = 24),
        margin = list(t = 50, b = 50),     
    geo = g,
    annotations = 
 list(x = 1, y = -0.1, text = "Source: Henry J Kaiser Family Foundation", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=0,
      font=list(size=12)))

p_1999 <- plot_geo(overdoses %>% filter(Year == 1999), locationmode = 'USA-states') %>%
  add_trace(
    z = ~Opioid_Death_Rate, locations = ~Abbrev, zmin = 0, zmax = 43,
    colors = 'Reds'
  ) %>%
  colorbar(title = "    Deaths \nPer 100,000 Residents") %>%
  layout(
    title = 'Opioid Deaths per 100,000 Residents, 1999',
        titlefont = list(size = 24),
        margin = list(t = 50, b= 50), 
    geo = g,
    annotations = 
 list(x = 1, y = -0.1, text = "Source: Henry J Kaiser Family Foundation", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=0,
      font=list(size=12)))
```

```{r, echo = FALSE}
p_1999
p_2006
p_2016
```





```{r, include = FALSE}
overdoses_99_16 <- overdoses %>% 
  filter(Year == 2016 | Year == 1999)  

overdoses_99_16 <- overdoses_99_16 %>% 
  spread(Year, Opioid_Death_Rate) %>% 
  mutate(Pct_Change = (`2016`- `1999`)/ `1999` ) 
```

```{r, echo = FALSE}
overdoses_99_16 %>%
  top_n(10, Pct_Change) %>%
  ggplot(aes(x= reorder(State, Pct_Change), y= Pct_Change)) + 
  geom_col(aes(fill = Pct_Change),show.legend = FALSE) +
  xlab('')+
  ylab('Percent Change') +
  ggtitle('Top 10 States by Percent Change in Opioid Deaths from 199 to 2016') +
  theme(plot.title = element_text(size=22), axis.text.x=element_text(size=20, angle = 55, hjust = .95), axis.title = element_text(size = 20), axis.text.y=element_text(size = 20))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))

```




```{r, echo = FALSE, include = FALSE}
total_prescriptions <- read_csv('data/State/prescribing_rate_full.csv')

# Total prescribing rate and death rate from 2006 to 2016
total_prescriptions <- total_prescriptions %>% group_by(State) %>% arrange(desc(Prescribing_Rate)) 
total_prescriptions_wide <-total_prescriptions %>% spread(Year,Prescribing_Rate) %>% arrange(desc(`2006`))
total_prescriptions_wide
State_names <- total_prescriptions_wide$State
State_names[1:5]
Top_states <- total_prescriptions %>% filter(State %in% State_names[1:5])
Top_states
a <- ggplot(Top_states, aes(Year, Prescribing_Rate, group = State, color = State)) + 
  geom_line(size = 1) +
  scale_y_continuous(labels = comma)+
  geom_point(size=3, shape=21, aes(fill=factor(State)))+
  labs(color = "US State", fill = 'US State')+
  ylab('Prescriptions per 100 Persons') +
  xlab('Year') +
  ggtitle('     Opioid prescribing rate in US') +
  theme_bw() + theme(legend.position="left",  axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16)
                     ) + labs(title = " Opioid Prescribing Rate",
       caption = "Source: Centers for Disease Control and Prevention") 

overdose_2006_2016 <- overdoses %>% filter(Year != 1999) %>% group_by(State) %>% mutate(Opioid_Death_Rate = as.numeric(Opioid_Death_Rate, na.rm=TRUE)) %>% arrange(desc(Opioid_Death_Rate))
overdose_2006_2016_wide <-overdose_2006_2016 %>% spread(Year,Opioid_Death_Rate)
State_names2 <- total_prescriptions_wide$State
State_names2[1:5]
overdose_2006_2016_x <- overdose_2006_2016 %>% filter(State %in% State_names2[1:5])
overdose_2006_2016_x
b <- ggplot(overdose_2006_2016_x, aes(Year, Opioid_Death_Rate, group = State, color = State)) + 
  geom_line(size = 1) +
  scale_y_continuous(labels = comma)+
  geom_point(size=3, shape=21, aes(fill=factor(State)))+
  labs(color = "US State", fill = 'US State')+
  ylab('Overdose Deaths per 100,000 Residents') +
  xlab('Year') +
  ggtitle('    ') +
  theme_bw() + theme(legend.position="none", axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16)) + labs(title = "Opioid Overdose Death Rate (Age Adjusted)",
       caption = "Source: Henry J Kaiser Family Foundation") 
```

```{r, echo = FALSE}
ggarrange(a,b,ncol = 2, nrow = 1, widths = c(1.25, 1))
```

```{r, include = FALSE}
heroin <- read_csv('data/State/By_Type/Heroin_2016.csv') %>% 
  rename(Heroin = `Crude Rate`) %>% select(State, Heroin)
synthetic <- read_csv('data/State/By_Type/Synthetic_2016.csv') %>% 
  rename(Synthetic = `Crude Rate`) %>% select(State, Synthetic)
prescription <- read_csv('data/State/By_Type/Prescription_2016.csv') %>% 
  rename(Prescription = `Crude Rate`) %>% select(State, Prescription)

by_cause <- heroin %>% full_join(synthetic) %>% full_join(prescription)

by_cause <- by_cause %>% inner_join(overdoses %>% filter(Year == 2016) %>% select(State, Opioid_Death_Rate))

by_cause <- by_cause %>% mutate(Pct_Heroin = Heroin / (Opioid_Death_Rate))
by_cause <- by_cause %>% mutate(Pct_Synthetic = Synthetic / (Opioid_Death_Rate))
by_cause <- by_cause %>% mutate(Pct_Prescription = Prescription / (Opioid_Death_Rate))

by_cause_long <- by_cause %>% select(State, Heroin = Pct_Heroin, Synthetic = Pct_Synthetic, Prescription = Pct_Prescription) %>% 
  gather(Cause, Percent, -State)

selected_states <- by_cause_long %>% filter(State %in% c('New Jersey', 'Illinois', 'Massachusetts', 
                                  'New Hampshire', 'Nevada', 'Utah'))

the_order <- data_frame(State = c('New Jersey', 'Illinois',  'Nevada', 'Utah',
                                  'Massachusetts', 'New Hampshire'), Order = 1:6)

selected_states <- selected_states %>% inner_join(the_order)
```

```{r, echo = FALSE}
ggplot(selected_states, aes(x = reorder(State, Order), y = Percent, fill = Cause)) +
  geom_bar(stat = 'identity', position = 'dodge') +   ylab('Percent of Opioid Deaths') +
  xlab('State') +
  ggtitle('    ') +
  theme_bw() + theme(legend.position="right", plot.title = element_text(size=22), axis.text.x=element_text(size=16, angle = 30, vjust = .5), axis.title = element_text(size = 20), axis.text.y=element_text(size = 20), legend.text=element_text(size=16)) + labs(title = "Opioid Overdose Deaths by Cause",
       caption = "Source: CDC WONDER") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(subtitle = "Note: Causes are not mutually exclusive, so percentages sum to greater than 100%")
```


```{r, include = FALSE}
library(tools)

op_list = c('CODEINE', 'BUPRENORPHINE', 'BUTORPHANOL',
            'FENTANYL', 'HYDROCODONE', 'HYDROMORPHONE', 'OXYCODONE', 'LEVORPHANOL',
            'MEPERIDINE', 'METHADONE', 'MORPHINE', 'NALBUPHINE', 'OPIUM', 'PENTAZOCINE',
            'TAPENTADOL', 'TRAMADOL')

opioid_prescribers_2016 <- read_csv('data/opioid_prescribers_2016.csv')
by_drug_2016 <- opioid_prescribers_2016 %>% 
  group_by(Generic_Name) %>% 
  summarize(Total_Claims = sum(Total_Claim_Count)) %>% 
  spread(Generic_Name, Total_Claims)
drugs_by_class_2016 <- op_list %>% 
  map(~ by_drug_2016 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%
  data.frame() %>% 
  gather(Drug, Claims)

opioids_2016_plot <- ggplot(data = drugs_by_class_2016 %>% top_n(5, Claims), 
                            aes(reorder(Drug, Claims), Claims)) +
  geom_bar(stat = 'identity', aes(fill = Claims),show.legend = FALSE) + coord_flip()+
  xlab('Drug') +
  ylab('Total Claims') +
  ggtitle('Top 5 Medicare Part D Claims, 2016') +
  scale_y_continuous(labels = comma, limits = c(0, 34000000))+
  theme_bw() +
  theme(plot.title = element_text(size=20), axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16)) +  scale_x_discrete( labels = function(x) toTitleCase(tolower(x)))

opioid_prescribers_2015 <- read_csv('data/opioid_prescribers_2015.csv')
by_drug_2015 <- opioid_prescribers_2015 %>% 
  group_by(Generic_Name) %>% 
  summarize(Total_Claims = sum(Total_Claim_Count)) %>% 
  spread(Generic_Name, Total_Claims)
drugs_by_class_2015 <- op_list %>% 
  map(~ by_drug_2015 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%
  data.frame() %>% 
  gather(Drug, Claims)

opioid_prescribers_2014 <- read_csv('data/opioid_prescribers_2014.csv')
by_drug_2014 <- opioid_prescribers_2014 %>% 
  group_by(Generic_Name) %>% 
  summarize(Total_Claims = sum(Total_Claim_Count)) %>% 
  spread(Generic_Name, Total_Claims)
drugs_by_class_2014 <- op_list %>% 
  map(~ by_drug_2014 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%
  data.frame() %>% 
  gather(Drug, Claims)

opioid_prescribers_2013 <- read_csv('data/opioid_prescribers_2013.csv')
by_drug_2013 <- opioid_prescribers_2013 %>% 
  group_by(Generic_Name) %>% 
  summarize(Total_Claims = sum(Total_Claim_Count)) %>% 
  spread(Generic_Name, Total_Claims)
drugs_by_class_2013 <- op_list %>% 
  map(~ by_drug_2013 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%
  data.frame() %>% 
  gather(Drug, Claims)

opioids_2013_plot <- ggplot(data = drugs_by_class_2013 %>% top_n(5, Claims), 
                            aes(reorder(Drug, Claims), Claims)) +
  geom_bar(stat = 'identity', aes(fill = Claims),show.legend = FALSE) + coord_flip()+
  xlab('Drug') +
  ylab('Total Claims') +
  ggtitle('Top 5 Medicare Part D Claims, 2013') +
  scale_y_continuous(labels = comma, limits = c(0, 34000000))+
  theme_bw() +
  theme(plot.title = element_text(size=20), axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16)) + scale_x_discrete( labels = function(x) toTitleCase(tolower(x)))
```


```{r, echo = FALSE}
ggarrange(opioids_2013_plot, opioids_2016_plot,
          ncol = 1, nrow = 2)
```

```{r, include = FALSE}
population <- read_csv('data/State/Demographics/Population.csv')

drugs_by_state_wide_2016 <- opioid_prescribers_2016 %>% group_by(State, Generic_Name) %>%
  summarize(Total_Prescriptions = sum(Total_Claim_Count)) %>% ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% inner_join(population %>% filter(Year == 2016)) %>%  
  mutate(Prescription_Rate = Total_Prescriptions/ totpop * 100) %>% 
  select(-Total_Prescriptions) %>% 
  spread(Generic_Name, Prescription_Rate) %>% 
  inner_join(overdoses %>% filter(Year == 2016)) %>% 
  mutate_all(funs(replace(.,is.na(.),0)))

drugs_by_state_wide_2016 <- op_list %>% 
  map(~ drugs_by_state_wide_2016 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%       
  bind_cols(drugs_by_state_wide_2016 %>% select(Year, Abbrev, State, Opioid_Death_Rate), .)

correlations <- cor(drugs_by_state_wide_2016 %>% select(-c(Year, State, Abbrev)))[1,] %>%
  data.frame() %>% 
  rownames_to_column() %>% 
  rename(Drug = rowname) %>%
  rename(Correlation = '.') %>% 
  filter(Drug != 'Opioid_Death_Rate')

library(tools)

correlations <-  correlations %>% mutate(Drug = toTitleCase(tolower(Drug)))

```

```{r, echo = FALSE}
ggplot(correlations, aes(x = reorder(Drug, Correlation), y = Correlation)) +
  coord_flip()+
  geom_col(aes(fill = Correlation),show.legend = FALSE) +
  xlab('Drug') +
  ylab('Correlation')+ 
  labs(title = "Correlation Between Prescribing Rate and Opioid Death Rate by State",
       caption = "Source: Medicare Part D Claims") +
  theme(plot.title = element_text(size=18), axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16))

```

```{r, include = FALSE}
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = FALSE,
  lakecolor = toRGB('white')
)
p1 <- plot_geo(drugs_by_state_wide_2016, locationmode = 'USA-states') %>%
  add_trace(z = ~HYDROCODONE, locations = ~Abbrev,
            color = ~HYDROCODONE, colors = 'Purples') %>%
  colorbar(title = "HYDROCODONE", x = -.12, y = .75, xanchor = 'left', yanchor = 'middle') %>%
  layout(geo =g, title = 'Hydrocodone Medicare Claims Per 100 Persons, 2016',        titlefont = list(size = 24),
        margin = list(t = 50) )

p2 <- plot_geo(drugs_by_state_wide_2016, locationmode = 'USA-states') %>%
  add_trace(z = ~OXYCODONE, locations = ~Abbrev,
            color = ~OXYCODONE, colors = 'Purples') %>%
  colorbar(title = "OXYCODONE", x = -.12, y = .75, xanchor = 'left', yanchor = 'middle') %>%
  layout(geo =g, title = 'Oxycodone Medicare Claims Per 100 Persons, 2016',         titlefont = list(size = 24),
        margin = list(t = 50))
```

```{r}
drugs_by_class <- drugs_by_state_wide_2016 %>% select(-c(Year, Abbrev)) %>% 
  gather(Drug, Claims, -c(State, Opioid_Death_Rate))

dat <- drugs_by_class %>% filter(Drug %in% c('HYDROCODONE', 'OXYCODONE', 'TRAMADOL')) %>% 
  mutate(Drug = as.factor(Drug))

dat %>%
  plot_ly() %>% 
  add_trace(x = ~as.numeric(Drug),y = ~Claims, color = ~Drug, type = "box", 
            hoverinfo = 'name+y') %>%
  add_markers(x = ~jitter(as.numeric(Drug)), y = ~Claims, color = ~Drug,
              marker = list(size = 6),
              hoverinfo = "text",
              text = ~paste0("State: ", State,
                             "<br>Claims Per 100 Persons: ", round(Claims, 2),
                             "<br>Opioid Deaths Per 100,000: ", Opioid_Death_Rate),
              showlegend = FALSE) %>% 
  layout(
  showlegend = FALSE,
  xaxis = list(title = "", tickmode = 'array', nticks = 3, tickvals = c(1,2,3),
               ticktext = c('Hydrocodone', 'Oxycodone', 'Tramadol'), tickfont = list(size = 20)),
  yaxis = list(title = 'Claims Per 100 Persons', titlefont = list(size = 20), tickfont = list(size = 18)),
  titlefont = list(size = 24),
  title = 'Medicare Claims Per 100 Persons, 2016',
  margin = list(t = 50)
  )
```


```{r, include = FALSE}
prescribers_by_state_2016 <- opioid_prescribers_2016 %>% 
  group_by(State) %>% 
  summarize(Prescribers = n_distinct(npi)) %>% 
  ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% 
  inner_join(population %>% filter(Year == 2016) %>% select(-Year)) %>% 
  mutate(Prescribers_Per_100000 = Prescribers / totpop * 100000) %>% 
  inner_join(overdoses %>% filter(Year == 2016) %>% select(State, Opioid_Death_Rate))

cor(prescribers_by_state_2016 %>% select(Prescribers_Per_100000, Opioid_Death_Rate))

p1 <- ggplot(prescribers_by_state_2016, aes(x = Prescribers_Per_100000, y = Opioid_Death_Rate)) + 
  geom_point()

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = FALSE,
  lakecolor = toRGB('white')
)
p1 <- plot_geo(prescribers_by_state_2016, locationmode = 'USA-states') %>%
  add_trace(z = ~Prescribers_Per_100000, locations = ~Abbrev,
            color = ~Prescribers_Per_100000, colors = 'Purples') %>%
  colorbar(title = "Number of Prescribers", x = -.12, y = .75, xanchor = 'left', yanchor = 'middle') %>%
  layout(geo =g, title = 'Opioid Prescribers Per 100,000 Residents, 2016',         titlefont = list(size = 24),
        margin = list(t = 50))
```

```{r, echo = FALSE}
p1
```




```{r, include = FALSE}
by_prescriber <- opioid_prescribers_2016 %>% 
  group_by(npi) %>% summarize(Total_prescriptions = sum(Total_Claim_Count)) %>% 
  ungroup() %>% 
  arrange(desc(Total_prescriptions)) %>% 
  mutate(relative_freq = Total_prescriptions / sum(Total_prescriptions),cumulative_freq = cumsum(relative_freq))
by_prescriber$rank <- 1:nrow(by_prescriber)
by_prescriber <- by_prescriber %>% mutate(percentile = rank/nrow(by_prescriber))
p3 <-   ggplot(data=by_prescriber,(aes(x = percentile, y = cumulative_freq))) +
  scale_y_continuous(label = scales::percent, limits = c(0, 1)) +
  geom_line() +
  labs(x = "1 - Prescriber Percentile", y = "Cumulative Prescriptions Count", 
       title = "A Pareto Diagram Showing 26.4% of Opioid Prescribers \n Responsible for 80% of Opioid Claims in 2016") +
  geom_hline(aes(yintercept = .8, linetype = "1F"), colour= 'blue',show.legend = FALSE) + 
  geom_vline(aes(xintercept = .264, linetype = "dotted"), colour= 'blue', show.legend = FALSE) +                                                                                                 
  theme(plot.title = element_text(size=18), axis.text.x=element_text(size=16), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16))
```

```{r, echo = FALSE, warning = FALSE}
p3
```


```{r, include = FALSE}
by_specialty <- opioid_prescribers_2016 %>% 
  group_by(Specialty) %>% summarize(Total_prescriptions = sum(Total_Claim_Count)) %>% 
  ungroup() %>% 
  arrange(desc(Total_prescriptions)) %>% 
  mutate(relative_freq = Total_prescriptions / sum(Total_prescriptions),cumulative_freq = cumsum(relative_freq)) %>% 
  filter(Specialty %in% Specialty[1:10])
the_order <- by_specialty$Specialty
p2 <-   ggplot(data=by_specialty,(aes(x = Specialty, weight = relative_freq))) +
  geom_bar(width = 0.5, aes(fill=Specialty),show.legend=FALSE) +
  scale_x_discrete(limits = the_order) +
  scale_y_continuous(label = scales::percent, limits = c(0, 1)) +
  geom_point(aes(x = Specialty, y = cumulative_freq), color = 'red') +
  geom_line(aes(x = Specialty, y = cumulative_freq, group = 1), color = 'red') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10))+
  geom_vline(aes(xintercept = 8, linetype = "dotted"), colour= 'blue', data = by_specialty, show.legend = FALSE) +                                                                                                     
  geom_hline(aes(yintercept = .8, linetype = "1F"), colour= 'blue', data = by_specialty,show.legend = FALSE) + 
  labs(x = "", y = "Cumulative Frequency", 
       title = "A Pareto diagram for Specialties \n Responsible for 80% of Opioid Claims") +
  theme(plot.title = element_text(hjust = 0.5, size = 18), axis.text.x = element_text(angle = 40,size = 12), axis.title = element_text(size = 16), axis.text.y=element_text(size = 16))
```

```{r, echo = FALSE}
p2
```

Our model uses the following predictors:
* Prescription Rate of each of 17 opioids, calculated from Medicare Data
* Overall prescription rate for all opioids, obtained from the CDC
* Various measures obtained from the Census Bureau:
+ Labor Force Participation Rate
+ Unemployment Rate
+ Median Income
+ Percentage of Population with Less Than a High School Education
+ Percent of the Population Non-Hispanic White
+ Percentage of the Population Living in a Rural Area
+ Percentage of Males who are Unmarried
* Share of the vote in the 2016 election going to Donald Trump
* Number of Suboxone Prescribers per 100,000 Residents, calculated from Medicare Data
* Number of Facilities Providing Some Medication Assisted Treatment per 100,000 residents, obtained from The Foundation for AIDS Research.
* Region of the country, as defined by the Census Bureau.

```{r, include = FALSE}
prescribers_by_state_2015 <- opioid_prescribers_2015 %>% 
  group_by(State) %>% 
  summarize(Prescribers = n_distinct(npi)) %>% 
  ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% 
  inner_join(population %>% filter(Year == 2015) %>% select(-Year)) %>% 
  mutate(Prescribers_Per_100000 = Prescribers / totpop * 100000) %>% 
  inner_join(overdoses %>% filter(Year == 2015) %>% select(State, Opioid_Death_Rate))

prescribers_by_state_2014 <- opioid_prescribers_2014 %>% 
  group_by(State) %>% 
  summarize(Prescribers = n_distinct(npi)) %>% 
  ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% 
  inner_join(population %>% filter(Year == 2014) %>% select(-Year)) %>% 
  mutate(Prescribers_Per_100000 = Prescribers / totpop * 100000) %>% 
  inner_join(overdoses %>% filter(Year == 2014) %>% select(State, Opioid_Death_Rate))

prescribers_by_state_2013 <- opioid_prescribers_2013 %>% 
  group_by(State) %>% 
  summarize(Prescribers = n_distinct(npi)) %>% 
  ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% 
  inner_join(population %>% filter(Year == 2013) %>% select(-Year)) %>% 
  mutate(Prescribers_Per_100000 = Prescribers / totpop * 100000) %>% 
  inner_join(overdoses %>% filter(Year == 2013) %>% select(State, Opioid_Death_Rate))
```


```{r, include = FALSE}
drugs_by_state_wide_2015 <- opioid_prescribers_2015 %>% group_by(State, Generic_Name) %>%
  summarize(Total_Prescriptions = sum(Total_Claim_Count)) %>% ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% inner_join(population %>% filter(Year == 2015)) %>%  
  mutate(Prescription_Rate = Total_Prescriptions/ totpop * 100) %>% 
  select(-Total_Prescriptions) %>% 
  spread(Generic_Name, Prescription_Rate) %>% 
  inner_join(overdoses %>% filter(Year == 2015)) %>% 
  mutate_all(funs(replace(.,is.na(.),0)))

drugs_by_state_wide_2015 <- op_list %>% 
  map(~ drugs_by_state_wide_2015 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%       
  bind_cols(drugs_by_state_wide_2015 %>% select(Year, Abbrev, State, Opioid_Death_Rate), .)

drugs_by_state_wide_2014 <- opioid_prescribers_2014 %>% group_by(State, Generic_Name) %>%
  summarize(Total_Prescriptions = sum(Total_Claim_Count)) %>% ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% inner_join(population %>% filter(Year == 2014)) %>%  
  mutate(Prescription_Rate = Total_Prescriptions/ totpop * 100) %>% 
  select(-Total_Prescriptions) %>% 
  spread(Generic_Name, Prescription_Rate) %>% 
  inner_join(overdoses %>% filter(Year == 2014)) %>% 
  mutate_all(funs(replace(.,is.na(.),0)))

drugs_by_state_wide_2014 <- op_list %>% 
  map(~ drugs_by_state_wide_2014 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%       
  bind_cols(drugs_by_state_wide_2014 %>% select(Year, Abbrev, State, Opioid_Death_Rate), .)

drugs_by_state_wide_2013 <- opioid_prescribers_2013 %>% group_by(State, Generic_Name) %>%
  summarize(Total_Prescriptions = sum(Total_Claim_Count)) %>% ungroup() %>% 
  rename(Abbrev = State) %>% 
  inner_join(state_abbrev) %>% inner_join(population %>% filter(Year == 2013)) %>%  
  mutate(Prescription_Rate = Total_Prescriptions/ totpop * 100) %>% 
  select(-Total_Prescriptions) %>% 
  spread(Generic_Name, Prescription_Rate) %>% 
  mutate_all(funs(replace(.,is.na(.),0))) %>% 
  inner_join(overdoses %>% filter(Year == 2013))


drugs_by_state_wide_2013 <- op_list %>% 
  map(~ drugs_by_state_wide_2013 %>% 
        select(matches(.x)) %>%
        reduce(`+`)) %>%
  set_names(op_list) %>%       
  bind_cols(drugs_by_state_wide_2013 %>% select(Year, Abbrev, State, Opioid_Death_Rate), .)

drugs_by_state <- rbind(drugs_by_state_wide_2016, drugs_by_state_wide_2015, drugs_by_state_wide_2014, drugs_by_state_wide_2013)

Predictors <- read_csv('data/State/Predictors.csv')

drugs_by_state <- drugs_by_state %>% inner_join(Predictors) %>% inner_join(total_prescriptions)

drugs_by_state <- drugs_by_state %>% filter(!is.na(Opioid_Death_Rate))

prescribers_by_state <- rbind(prescribers_by_state_2013 %>% mutate(Year = 2013) %>% select(State, Year, Prescribers_Per_100000),
prescribers_by_state_2014 %>% mutate(Year = 2014) %>% select(State, Year, Prescribers_Per_100000),
prescribers_by_state_2015 %>% mutate(Year = 2015) %>% select(State, Year, Prescribers_Per_100000), prescribers_by_state_2016 %>% mutate(Year = 2016) %>% select(State, Year, Prescribers_Per_100000))

drugs_by_state <- drugs_by_state %>% inner_join(prescribers_by_state)

drugs_by_state <- drugs_by_state %>% select(-totpop)
```

```{r}
library(fastDummies)
Regions <- read_csv('data/State/Regions.csv') %>% mutate(Division = str_replace_all(Division, ' ', '_'))
drugs_by_state <- drugs_by_state %>% inner_join(Regions)
drugs_by_state <-drugs_by_state %>% dummy_cols(select_columns = 'Division') %>% select(-Division)
drugs_by_state <- drugs_by_state %>% select(-BUPRENORPHINE)
```


```{r, echo = FALSE}
set.seed(321)
train_test <- sample(unique(drugs_by_state[['Abbrev']]), 10, replace = FALSE)
train <- drugs_by_state %>% filter(!(Abbrev %in% train_test)) %>% select(-c(Abbrev, State, Year))
test <- drugs_by_state %>% filter(Abbrev %in% train_test) %>% select(-c(Abbrev, State, Year))

rf_fit <- train(Opioid_Death_Rate~.,data=train, method = 'ranger', importance = 'impurity')
test$predictions <- predict(rf_fit, test)

mae <- mean(abs(test$Opioid_Death_Rate - test$predictions))
print(mae)

ggplot(aes(Opioid_Death_Rate, predictions), data = test) +
  geom_point() +
  geom_smooth() +
  geom_line(aes(Opioid_Death_Rate, Opioid_Death_Rate), color = 'red')

varImp(rf_fit)
```

```{r, echo = FALSE}
gbm_fit <- train(Opioid_Death_Rate~.,data=train, method = 'gbm', verbose = FALSE)
gbm_fit
test$predictions <- predict(gbm_fit, test)
mae <- mean(abs(test$Opioid_Death_Rate - test$predictions))
print(mae)

ggplot(aes(Opioid_Death_Rate, predictions), data = test) +
  geom_point() +
  geom_smooth() +
  geom_line(aes(Opioid_Death_Rate, Opioid_Death_Rate), color = 'red')
```

